<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset='UTF-8'>
  <meta name='viewport' content='width=device-width initial-scale=1'>
  <script type="module">
    import { app } from "./hyperapp.js";
    import html from "./hyperlit.js";

    // TODO hyperlit
    // add styles
    // TODO typescript?

    class Lens {
      constructor({get, set}) {
        this.get = get;
        this.set = set;
        this.update = (s, f) =>this.set(s, f(this.get(s)));
        this.lens = this;
      }

      // TODO make field and array the same method?
      static array(i) {
        return new Lens({
          get: (a) => a[i],
          set: (a, new_e) => {
            // TODO should I get rid of this? or get rid of `field`?
            if (a.map === undefined) {
              return { ...a, [i]: new_e };
            }
            return a.map((item, index) => {
              if (index !== i) {
                return item;
              }

              return new_e;
            });
          }
        });
      }

      static field(name) {
        return new Lens({ get: (s) => s[name], set: (s, u) => ({ ...s, [name]: u })});
      }

      array(i) {
        return this.compose(Lens.array(i))
      }

      field(name) {
        return this.compose(Lens.field(name))
      }

      static reducer(f) {
        return (l) => (state, ...args) => l.update(state, (s) => f(s, ...args))
      }

      reducer(f) {
        return Lens.reducer(f)(this);
      }

      props(state) {
        return {value: this.get(state), state: state, lens: this};
      }

      compose(other) {
        return new Lens({
          get: (x) => other.get(this.get(x)),
          set:(x, u) => this.set(x, other.set(this.get(x), u))
        });
      }

    }

    const lens = (q) => (r) => {
      let foo = Lens.array(q);
      if (r === undefined) {
        return foo
      } else {
        return (s) => foo.compose(lens(r)(s));
      }
    }

    const inc = Lens.reducer(count => count + 1);

    const dec = Lens.reducer(count => count - 1);

    const Counter = ({value, state, lens}) => {
      return html`
      <div>
        <h4>${value}</h4>
        <button onclick=${inc(lens)}>Inc</button>
        <button onclick=${dec(lens)}>Dec</button>
      </div>`;
    }


    const AddTodo = Lens.field("counts").reducer(counts => counts.concat(0));


    app({
      init: { todos: [], value: "", counts: [] },
      view: (state) => html`
      <main>
        <button onclick=${AddTodo}>Add</button>
        <ul>
          ${state.counts.map((count, i) => Counter({ ...lens("counts")(i)().props(state) }))}
        </ul>
      </main>`,
      node: document.getElementById("app"),
    })
  </script>
</head>

<body>
  <main id="app"></main>
</body>

</html>
